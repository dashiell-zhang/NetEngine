@page "/systemset/role"
@using System.ComponentModel
@using Application.Model.User.Role
@attribute [ReuseTabsPageTitle("角色管理")]

<div style="margin-bottom:10px">

    @if (functionList.Contains("role-add"))
    {
        <Button Icon="plus" Type="@ButtonType.Primary" @onclick="() => EditRole()">添加</Button>
    }

</div>
<Table TItem="RoleDto" DataSource="@pageList.List" Total="@pageList.Total" Loading="tableLoading" RemoteDataSource>

    <ColumnDefinitions>
        <PropertyColumn Property="c => c.Code" Title="编码"></PropertyColumn>
        <PropertyColumn Property="c => c.Name" Title="名称"></PropertyColumn>
        <PropertyColumn Property="c => c.Remarks" Title="备注"></PropertyColumn>
        <PropertyColumn Property="c => c.CreateTime.LocalDateTime" Format="yyyy-MM-dd HH:mm" Title="创建时间"></PropertyColumn>
        <ActionColumn Title="操作">
            <Space>

                @if (functionList.Contains("role-edit"))
                {
                    <SpaceItem>
                        <a @onclick="() => EditRole(context)">编辑</a>
                    </SpaceItem>
                }

                @if (functionList.Contains("role-function"))
                {
                    <SpaceItem>
                        <a @onclick="() => EditAuthorityAsync(context.Id)" style="color:darkorchid">权限范围</a>
                    </SpaceItem>
                }

                @if (functionList.Contains("role-delete"))
                {
                    <SpaceItem>
                        <Popconfirm Title="确认要删除吗？"
                                    OnConfirm="_=>DeleteRoleAsync(context.Id)"
                                    OkText="Yes"
                                    CancelText="No">
                            <a style="color:red">删除</a>
                        </Popconfirm>

                    </SpaceItem>
                }

            </Space>
        </ActionColumn>
    </ColumnDefinitions>

    <PaginationTemplate>
        <div style="margin:15px 0;float:right">
            <Pagination Total="@pageList.Total" PageSize="pageSize" Current="pageNum" ShowSizeChanger OnChange="PageChange" ShowQuickJumper ShowTotal="showTotal" />
        </div>
    </PaginationTemplate>

</Table>


<Drawer Closable="true" Width="380" Visible="isShowEditRole" Title='("角色信息")' OnClose="() => isShowEditRole = false">
    <Template style="height:90%">

        <Form Model="@editRole" OnFinish="SaveRoleAsync">

            <FormItem>
                <Text>编码</Text>
                <Input Placeholder="请输入编码" @bind-Value="@context.Code" />
            </FormItem>

            <FormItem>
                <Text>名称</Text>
                <Input Placeholder="请输入名称" @bind-Value="@context.Name" />
            </FormItem>

            <FormItem>
                <Text>备注</Text>
                <Input Placeholder="请输入备注" @bind-Value="@context.Remarks" />
            </FormItem>

            <Row Gutter="24">
                <AntDesign.Col Span="24">
                    <div style="float:right">
                        <Button Type="@ButtonType.Primary" HtmlType="submit" Loading="@saveLoading">保存</Button>
                        <Button Type="@ButtonType.Default" @onclick="() => isShowEditRole = false">取消</Button>
                    </div>
                </AntDesign.Col>
            </Row>
        </Form>
    </Template>
</Drawer>


<Modal Title="权限范围" Style="width:1160px;" Visible="@isShowEditAuthority" OnCancel="() => isShowEditAuthority = false" Footer="null" MaxBodyHeight="@("70vh")">
    <Table DataSource="roleFunctionList" TreeChildren="item => item.ChildList" DefaultExpandAllRows HidePagination>

        <Column Title="菜单模块" TData="string">
            <Checkbox Label="@context.Id.ToString()" @bind-Value="context.IsCheck" OnChange="isCheck => SetRoleFunctionAsync(context.Id, isCheck)">@context.Name</Checkbox>
        </Column>

        <Column Title="功能操作" TData="string">
            <Row>
                @foreach (var item in context.FunctionList)
                {
                    <Checkbox Label="@item.Id.ToString()" @bind-Value="item.IsCheck" OnChange="isCheck => SetRoleFunctionAsync(item.Id, isCheck)">@item.Name</Checkbox>
                }
            </Row>
        </Column>

    </Table>

</Modal>


@code {

    List<string> functionList = new();

    override protected async Task OnInitializedAsync()
    {
        functionList = await userContextService.GetFunctionList();

        await GetRoleListAsync();
    }

    bool saveLoading = false;
    bool tableLoading = false;
    int pageNum = 1;
    int pageSize = 10;


    bool isShowEditAuthority = false;


    PageListDto<RoleDto> pageList = new();

    List<RoleFunctionDto> roleFunctionList = new();

    async Task GetRoleListAsync()
    {
        tableLoading = true;
        var retData = await Http.GetFromJsonAsync<PageListDto<RoleDto>>("Role/GetRoleList?pageNum=" + pageNum + "&pageSize=" + pageSize, JsonHelper.DeserializeOpts);

        if (retData != null)
        {
            pageList = retData;
        }

        tableLoading = false;
        StateHasChanged();
    }

    void PageChange(PaginationEventArgs args)
    {
        if (pageNum != args.Page)
        {
            pageNum = args.Page;
        }

        if (pageSize != args.PageSize)
        {
            pageSize = args.PageSize;
        }

        GetRoleListAsync();
    }

    Func<PaginationTotalContext, string> showTotal = pageList => $"共 {pageList.Total} 条";


    bool isShowEditRole = false;

    long roleId;
    EditRoleDto editRole = new();

    void EditRole(RoleDto? role = null)
    {
        roleId = default;
        editRole = new EditRoleDto();

        if (role != null)
        {
            roleId = role.Id;
            editRole.Code = role.Code;
            editRole.Name = role.Name;
            editRole.Remarks = role.Remarks;
        }


        isShowEditRole = true;

        StateHasChanged();
    }

    async Task SaveRoleAsync()
    {
        saveLoading = true;
        if (roleId == default)
        {
            using var httpResponse = await Http.PostAsJsonAsync<EditRoleDto>("Role/CreateRole", editRole, JsonHelper.SerializeOpts);
            if (httpResponse.IsSuccessStatusCode)
            {
                Message.Success("添加成功");
            }
        }
        else
        {
            using var httpResponse = await Http.PostAsJsonAsync<EditRoleDto>("Role/UpdateRole?roleId=" + roleId, editRole, JsonHelper.SerializeOpts);
            if (httpResponse.IsSuccessStatusCode)
            {
                Message.Success("编辑成功");
            }
        }
        saveLoading = false;

        GetRoleListAsync();
        isShowEditRole = false;
    }


    async Task DeleteRoleAsync(long roleId)
    {
        using var httpResponse = await Http.DeleteAsync("Role/DeleteRole?id=" + roleId);
        if (httpResponse.IsSuccessStatusCode)
        {
            GetRoleListAsync();
            Message.Success("删除成功");
        }
    }


    async Task EditAuthorityAsync(long roleId)
    {
        this.roleId = roleId;

        var retData = await Http.GetFromJsonAsync<List<RoleFunctionDto>>("Role/GetRoleFunction?roleId=" + roleId, JsonHelper.DeserializeOpts);

        if (retData != null)
        {
            roleFunctionList = retData;
        }

        isShowEditAuthority = true;

        StateHasChanged();
    }


    async Task SetRoleFunctionAsync(long functionId, bool isCheck)
    {
        SetRoleFunctionDto setRoleFunction = new()
        {
            RoleId = roleId,
            FunctionId = functionId,
            IsCheck = isCheck
        };

        using var httpResponse = await Http.PostAsJsonAsync<SetRoleFunctionDto>("Role/SetRoleFunction", setRoleFunction, JsonHelper.SerializeOpts);
        if (httpResponse.IsSuccessStatusCode)
        {
            Message.Success("设置成功");
        }
    }


}
